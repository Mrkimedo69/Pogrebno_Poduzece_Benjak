<section *ngIf="!isAdmin" class="surface-section py-6 px-4">
  <div class="mx-auto" style="max-width: 1200px">

    <!-- Naslov i opis -->
    <h2 class="text-3xl md:text-4xl font-bold text-center text-primary-800 mb-4">
      Interaktivni dizajn grobnice i spomenika
    </h2>

    <p class="text-lg text-center text-color-secondary mb-5" style="max-width: 700px; margin: 0 auto;">
      Prilagodite izgled i dimenzije grobnog prostora te pogledajte 2D i 3D model u stvarnom vremenu.
    </p>

    <!-- Kontrole -->
    <div class="grid formgrid p-fluid mb-6">
      <div class="field col-12 md:col-6 lg:col-4">
        <label class="font-bold mb-2">Materijal</label>
        <p-dropdown
          [options]="store.materijali()"
          [ngModel]="store.odabraniMaterijal()"
          (ngModelChange)="onMaterijalChange($event)"
          placeholder="Odaberite materijal"
          optionLabel="name">
        </p-dropdown>
      </div>

      <div class="field col-12 md:col-6 lg:col-4">
        <label class="font-bold mb-2">Oblik spomenika</label>
        <p-dropdown
          [options]="store.oblici"
          [(ngModel)]="odabraniOblik"
          (ngModelChange)="onOblikChange($event)"
          optionLabel="label"
        ></p-dropdown>
      </div>

      <div class="field col-12 md:col-6 lg:col-4">
        <label class="font-bold mb-2">Tip grobnog mjesta</label>
        <p-dropdown
          [options]="[
            { label: 'Jednostruki grob', value: 'jedno' },
            { label: 'Dvostruki grob', value: 'duplo' }
          ]"
          [(ngModel)]="tipMjesta"
          (ngModelChange)="onTipMjestaChange()"
          placeholder="Odaberite tip"
        ></p-dropdown>
      </div>

      <div class="field col-12 md:col-6 lg:col-4">
        <label class="font-bold mb-2">Debljina mramorne ploče (cm)</label>
        <p-slider
          [min]="2"
          [max]="6"
          [step]="1"
          [(ngModel)]="sliderDebljina"
          (onChange)="onDebljinaChange($event)"
        ></p-slider>
        <small class="text-color-secondary">Odabrano: {{ sliderDebljina }} cm</small>
      </div>

      <div class="field col-12 md:col-6 lg:col-4">
        <label class="font-bold mb-2">Visina okvira (cm)</label>
        <p-slider
          [min]="12"
          [max]="20"
          [step]="1"
          [(ngModel)]="sliderVisina"
          (onChange)="onVisinaChange($event)"
        ></p-slider>
        <small class="text-color-secondary">Odabrano: {{ sliderVisina }} cm</small>
      </div>

      <div class="field col-12 md:col-6 lg:col-4">
        <label class="font-bold mb-2">Nagib tla (%)</label>
        <p-slider
          [min]="0"
          [max]="15"
          [step]="1"
          [(ngModel)]="sliderNagib"
          (onChange)="onNagibChange($event)"
        ></p-slider>
        <small class="text-color-secondary">Odabrano: {{ sliderNagib }} %</small>
      </div>
    </div>

    <!-- Gumbi -->
    <div class="flex flex-wrap justify-content-center gap-3 mb-5">
      <button pButton label="Zatraži ponudu" icon="pi pi-envelope" class="p-button-outlined p-button-lg" (click)="openDialog()"></button>
      <button
        pButton
        [label]="prikazi2D ? 'Sakrij 2D prikaz' : 'Prikaži 2D prikaz'"
        icon="pi pi-image"
        class="p-button-lg"
        (click)="toggle2D()">
      </button>
      <button
        pButton
        [label]="prikazi3D ? 'Sakrij 3D prikaz' : 'Prikaži 3D model'"
        icon="pi pi-cube"
        class="p-button-lg"
        (click)="toggle3D()">
      </button>
      <button
        *ngIf="isAdmin"
        pButton
        label="Uredi materijale"
        icon="pi pi-cog"
        class="p-button-warning p-button-lg"
        (click)="onAddNewMaterial()">
      </button>
    </div>

    <!-- Skriveni statični 2D prikaz za generiranje slike (manje dimenzije, brže slanje) -->
    <div
      #hidden2dContainer
      *ngIf="ploca2dData?.length"
      style="position: absolute; top: -9999px; left: -9999px; width: 1100px; padding: 12px; background: white;"
    >
      <div style="text-align: center; margin-bottom: 12px;">
        <h3 style="margin-bottom: 0; font-size: 16px;">2D Prikaz dizajna</h3>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;">
        <div
          *ngFor="let ploca of ploca2dData"
          style="border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 12px;"
        >
          <div style="font-weight: bold; margin-bottom: 6px;">{{ ploca.naziv }}</div>

          <svg
            *ngIf="isTrapezna(ploca)"
            [attr.width]="ploca.width * 70"
            [attr.height]="getMaxHeight(ploca) * 80"
            style="border: 1px solid #000;"
          >
            <polygon
              [attr.points]="getTrapezPoints(ploca)"
              [attr.fill]="ploca.boja || '#ccc'"
              stroke="black"
            />
          </svg>

          <svg
            *ngIf="isPravokutna(ploca)"
            [attr.width]="ploca.width * 70"
            [attr.height]="ploca.height * 80"
            style="border: 1px solid #000;"
          >
            <rect
              x="0"
              y="0"
              [attr.width]="ploca.width * 70"
              [attr.height]="ploca.height * 80"
              [attr.fill]="ploca.boja || '#ccc'"
              stroke="black"
            />
          </svg>

          <div style="margin-top: 4px; color: #666;">
            <ng-container *ngIf="isTrapezna(ploca)">
              {{ ploca.width * 100 }} cm x {{ ploca.height1 * 100 }}-{{ ploca.height2 * 100 }} cm
            </ng-container>
            <ng-container *ngIf="isPravokutna(ploca)">
              {{ ploca.width * 100 }} cm x {{ ploca.height * 100 }} cm
            </ng-container>
          </div>
        </div>
      </div>
    </div>


    <!-- 2D Prikaz -->
    <div *ngIf="prikazi2D" class="two-d-section surface-card p-4 border-1 border-round mb-6">
      <h4 class="text-center text-primary-700 font-semibold mb-4">2D Pregled</h4>

      <div class="grid">
        <div
          *ngFor="let ploca of ploca2dData"
          class="col-12 sm:col-6 lg:col-3 p-2"
        >
          <div class="border-1 border-round p-3 text-center bg-gray-100">
            <div class="font-semibold text-sm mb-2">{{ ploca.naziv }}</div>

            <svg
              *ngIf="isTrapezna(ploca)"
              [attr.width]="ploca.width * 100"
              [attr.height]="getMaxHeight(ploca) * 100"
              class="mx-auto border"
            >
              <polygon
                [attr.points]="getTrapezPoints(ploca)"
                [attr.fill]="ploca.boja || '#ccc'"
                stroke="black"
              />
            </svg>

            <svg
              *ngIf="isPravokutna(ploca)"
              [attr.width]="ploca.width * 100"
              [attr.height]="ploca.height * 100"
              class="mx-auto border"
            >
              <rect
                x="0"
                y="0"
                [attr.width]="ploca.width * 100"
                [attr.height]="ploca.height * 100"
                [attr.fill]="ploca.boja || '#ccc'"
                stroke="black"
              />
            </svg>

            <div class="text-xs mt-2 text-color-secondary">
              <ng-container *ngIf="isTrapezna(ploca)">
                {{ ploca.width * 100 }} cm x {{ ploca.height1 * 100 }}-{{ ploca.height2 * 100 }} cm
              </ng-container>
              <ng-container *ngIf="isPravokutna(ploca)">
                {{ ploca.width * 100 }} cm x {{ ploca.height * 100 }} cm
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>
    <app-monument-request-dialog
      [visible]="dialogVisible"
      [email]="userEmail"
      (submitRequest)="onSendRequest($event)"
      (close)="dialogVisible = false">
    </app-monument-request-dialog>
    <p-dialog
      [(visible)]="materialDialogOpen"
      [modal]="true"
      [style]="{ width: '100%', maxWidth: '600px' }"
      [contentStyle]="{ 'max-height': '80vh', 'overflow-y': 'auto' }"
      header="{{ selectedMaterial ? 'Uredi materijal' : 'Novi materijal' }}"
      (onHide)="onCloseMaterialDialog(false)"
    >
      <app-admin-material-form
        [material]="selectedMaterial"
        (close)="onCloseMaterialDialog($event)">
      </app-admin-material-form>
    </p-dialog>


    <!-- 3D Prikaz -->
    <div *ngIf="prikazi3D" class="surface-card p-4 border-1 border-round mb-6">
      <h4 class="text-center text-xl font-semibold text-primary-700 mb-3">3D Prikaz</h4>
      <div #threeContainer style="width: 100%; max-width: 1000px; height: 800px; margin: auto;" class="border-1 border-round mb-4"></div>
      <div class="text-center text-sm text-color-secondary">
        <p><strong>Materijal:</strong> {{ store.odabraniMaterijal()?.name }}</p>
        <p><strong>Oblik:</strong> {{ store.odabraniOblik().label }}</p>
        <p class="text-2xl font-bold text-green-700 mt-3 mb-2">
          Ukupna cijena: {{ store.cijena()*povrsinaMaterijalaM2 | number: '1.2-2'}} €
        </p>
        <p><strong>Ukupna površina materijala:</strong> {{ povrsinaMaterijalaM2 }} m²</p>
      </div>
    </div>

  </div>
</section>

<section *ngIf="isAdmin" class="surface-section py-6 px-4">
  <div class="mx-auto" style="max-width: 1200px">

    <h2 class="text-3xl md:text-4xl font-bold text-center text-primary-800 mb-5">
      Upravljanje materijalima
    </h2>

    <!-- Prikaz liste materijala (samo za admina) -->
    <div class="surface-card border-1 border-round p-4 shadow-2">

      <div class="flex justify-content-between align-items-center mb-4">
        <h3 class="text-xl font-bold text-primary-800 m-0">Popis svih materijala</h3>
        <button pButton icon="pi pi-plus" label="Dodaj novi" class="p-button-success"
                (click)="onAddNewMaterial()"></button>
      </div>

      <div class="grid">
        <div *ngFor="let mat of store.materijali()" class="col-12 md:col-6 lg:col-4 p-2">
          <div class="border-1 border-round p-3 bg-gray-50 h-full cursor-pointer hover:surface-hover transition"
               (click)="onEditMaterial(mat)">
            <div class="font-semibold text-primary-700 text-lg mb-2">{{ mat.name }}</div>

            <div class="flex items-center gap-2 mb-2">
              <span>Boja:</span>
              <span class="w-2rem h-2rem border-round" [style.backgroundColor]="mat.colorHex"
                    style="border: 1px solid #ccc;"></span>
            </div>

            <div class="mb-2">
              <span class="text-gray-600">Cijena:</span>
              <strong>{{ mat.pricePerM2 }} €/m²</strong>
            </div>

            <div *ngIf="mat.textureUrl">
            <img [src]="store.getImageUrl(mat.textureUrl)"
                class="mt-2 w-full h-5rem border-1 border-300 border-round object-cover" />
            </div>

            <p-tag class="mt-3 block" [value]="mat.isAvailable ? 'Dostupan' : 'Nedostupan'"
                   [severity]="mat.isAvailable ? 'success' : 'danger'"></p-tag>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dijalog za dodavanje/uređivanje -->
  <p-dialog
    [(visible)]="materialDialogOpen"
    [modal]="true"
    [style]="{ width: '100%', maxWidth: '600px' }"
    [contentStyle]="{ 'max-height': '80vh', 'overflow-y': 'auto' }"
    header="{{ selectedMaterial ? 'Uredi materijal' : 'Novi materijal' }}"
    (onHide)="onCloseMaterialDialog(false)"
  >
    <app-admin-material-form
      [material]="selectedMaterial"
      (close)="onCloseMaterialDialog($event)">
    </app-admin-material-form>
  </p-dialog>
</section>


